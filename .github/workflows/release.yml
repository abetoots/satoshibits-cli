name: ðŸš€ Release using changesets

on:
  push:
    branches:
      - main

permissions: write-all

env:
  PNPM_CACHE_FOLDER: ${{ github.workspace }}/.pnpm-store
  # changesets/action presumes the .npmrc is in $HOME so it doesn't respect the project's .npmrc
  # actions/setup-node sets up a .npmrc in $HOME and sets it from env.NODE_AUTH_TOKEN
  # See:
  # - https://github.com/changesets/action/issues/58
  # - https://github.com/changesets/action/issues/147
  # - https://github.com/actions/setup-node/blob/78148dae5052c4942d5b0f92719061df122a3b1c/src/authutil.ts#L41

  NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

# Ensure that only a single job or workflow using the same concurrency group will run at a time
# This negates the need for styfle/cancel-workflow-action
concurrency:
  # Ensures that we process concurrently by branch using `github.ref` as the key
  group: ${{ github.workflow }}-${{ github.ref }}
  # If a run is in progress for a specific branch, cancel the current run and start a new run
  cancel-in-progress: true

jobs:
  release:
    name: ðŸš€ Build and release
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: âŽ” Setup node
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - name: Install pnpm package manager
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - uses: actions/cache@v4
        name: âš¡ï¸ Cache pnpm store
        with:
          path: ${{ env.PNPM_CACHE_FOLDER }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Download deps
        run: pnpm install --prefer-offline

      - name: Capture new release versions
        id: get_versions
        run: |
          # Use the changeset CLI to get the status output as JSON
          # This example uses 'jq' to parse the JSON and format the message
          # Install jq if it's not already available in your runner image
          # e.g., run: sudo apt-get install jq
          CHANGED_PACKAGES=$(npx @changesets/cli status --output=json | jq -r '.releases | map(.name + "@" + .newVersion) | join(", ")')
          # Set a GITHUB_ENV variable with the dynamic message
          echo "CS_COMMIT_MESSAGE=chore(release): version packages ${CHANGED_PACKAGES}" >> $GITHUB_ENV

      # Make sure you permit Github Actions to create or approve pull requests
      # https://stackoverflow.com/questions/72376229/github-actions-is-not-permitted-to-create-or-approve-pull-requests-createpullre
      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          publish: pnpm run ci:release
          # Use the dynamically created environment variable for commit and title
          commit: ${{ env.CS_COMMIT_MESSAGE }}
          title: ${{ env.CS_COMMIT_MESSAGE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
# TODO Add step for publishing to JSR
