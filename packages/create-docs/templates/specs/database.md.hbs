---
id: TSD-DATABASE
title: "{{title}}"
type: technical-spec
status: Draft
version: "1.0.0"
created_date: "{{currentDate}}"
last_updated: "{{currentDate}}"
owner: "{{owner}}"
---

# Database Specification

**Project:** {{projectName}}

## 1. Overview

This document defines the database schema, conventions, and access patterns for {{projectName}}.

## 2. Database Configuration

| Setting | Development | Production |
|---------|-------------|------------|
| Engine | PostgreSQL 15 | PostgreSQL 15 |
| Host | localhost | *RDS/Cloud SQL* |
| Port | 5432 | 5432 |
| Database | {{projectName}}_dev | {{projectName}}_prod |

## 3. Schema Conventions

### 3.1 Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Tables | snake_case, plural | `users`, `user_sessions` |
| Columns | snake_case | `created_at`, `user_id` |
| Primary Keys | `id` (UUID) | `id UUID PRIMARY KEY` |
| Foreign Keys | `<table>_id` | `user_id` |
| Indexes | `idx_<table>_<columns>` | `idx_users_email` |

### 3.2 Standard Columns

Every table includes:

```sql
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
```

## 4. Schema Definition

### 4.1 Entity Relationship Diagram

```mermaid
erDiagram
    users ||--o{ user_sessions : has
    users {
        uuid id PK
        varchar email UK
        varchar password_hash
        varchar status
        timestamp created_at
        timestamp updated_at
    }
    user_sessions {
        uuid id PK
        uuid user_id FK
        varchar token_hash
        timestamp expires_at
        timestamp created_at
    }
```

### 4.2 Table: users

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

### 4.3 Table: user_sessions

```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
```

## 5. Migrations

### 5.1 Migration Naming

```
YYYYMMDDHHMMSS_description.sql
```

Example: `20240101120000_create_users_table.sql`

### 5.2 Running Migrations

```bash
# apply all pending migrations
npm run db:migrate

# rollback last migration
npm run db:migrate:rollback

# create new migration
npm run db:migrate:create <name>
```

## 6. Access Patterns

### 6.1 Common Queries

**Get user by email:**
```sql
SELECT * FROM users WHERE email = $1;
```

**Get active sessions for user:**
```sql
SELECT * FROM user_sessions
WHERE user_id = $1 AND expires_at > NOW();
```

### 6.2 Query Optimization

- Use prepared statements for all queries
- Paginate large result sets
- Use `EXPLAIN ANALYZE` to verify query plans

## 7. Backup & Recovery

| Metric | Target |
|--------|--------|
| Backup Frequency | Daily |
| Retention Period | 30 days |
| RTO | 1 hour |
| RPO | 24 hours |

---

## Related Documents

- [ADD - Data Model](../03-architecture/add.md#4-data-model-overview)
- [API Specification](./api.md)

---

*[‚Üê Back to TSD Index](./index.md)*
